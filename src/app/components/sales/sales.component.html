<div class="sales-container">
  <div class="header">
    <h1>üí∞ Sell Items!</h1>
    <div class="header-stats">
      <div class="stat-card cart">
        <span class="stat-icon">üõí</span>
        <span class="stat-label">Items</span>
        <span class="stat-value">{{ cartService.cartCount() }}</span>
      </div>
      <div class="stat-card total">
        <span class="stat-icon">üíµ</span>
        <span class="stat-label">Total</span>
        <span class="stat-value">${{ cartService.cartTotal().toFixed(2) }}</span>
      </div>
    </div>
  </div>

  <div class="action-bar">
    @if (!scanning()) {
      <button class="btn btn-primary btn-large fun-button" (click)="startScanning()">
        üì∑ Scan Item
      </button>
      <button class="btn btn-secondary btn-large fun-button" (click)="manualBarcodeEntry()">
        ‚å®Ô∏è Type Code
      </button>
      @if (cartService.cart().length > 0) {
        <button class="btn btn-success btn-large fun-button pulse" (click)="proceedToCheckout()">
          ‚úÖ Checkout
        </button>
        <button class="btn btn-danger btn-large fun-button" (click)="clearCart()">
          üóëÔ∏è Clear
        </button>
      }
    } @else {
      <div class="scanning-controls">
        <button class="btn btn-danger btn-large fun-button" (click)="stopScanning()">
          ‚èπÔ∏è Stop Scanning
        </button>
        
        <button 
          class="btn btn-large fun-button scan-mode-toggle"
          [class.single-mode]="singleScanMode()"
          [class.quantity-mode]="!singleScanMode()"
          (click)="toggleScanMode()">
          @if (singleScanMode()) {
            <span class="mode-icon">1Ô∏è‚É£</span>
            <span class="mode-text">One at a Time</span>
          } @else {
            <span class="mode-icon">üî¢</span>
            <span class="mode-text">Quantity Mode</span>
          }
        </button>

        @if (!singleScanMode()) {
          <div class="scan-quantity-control">
            <label>Quantity per scan:</label>
            <input 
              type="number" 
              min="1" 
              [value]="scanQuantity()"
              (input)="scanQuantity.set(+$any($event.target).value)"
              class="quantity-input">
          </div>
        }
      </div>
    }
  </div>

  @if (scanning()) {
    <div class="scanner-container">
      <div class="scan-instruction">
        <h3>üì∏ Scan to add to your cart!</h3>
        <p>Point at the barcode and hold steady! ‚ú®</p>
      </div>
      <div class="scanner-wrapper">
        <zxing-scanner
          (scanSuccess)="onScanSuccess($event)"
          (scanError)="onScanError($event)"
          [formats]="barcodeFormats">
        </zxing-scanner>
      </div>
    </div>
  }

  <div class="cart-section">
    <h2>üõí Shopping Cart</h2>
    
    @if (cartService.cart().length === 0) {
      <div class="empty-cart">
        <div class="empty-icon">üõí</div>
        <h3>Cart is Empty!</h3>
        <p>Scan items to start selling! üåü</p>
      </div>
    } @else {
      <div class="cart-items">
        @for (cartItem of cartService.cart(); track cartItem.item.barcode) {
          <div class="cart-item">
            <div class="item-info">
              <h3>{{ cartItem.item.name }}</h3>
              <p class="barcode">{{ cartItem.item.barcode }}</p>
              <p class="price">${{ cartItem.item.price.toFixed(2) }} each</p>
            </div>
            
            <div class="item-controls">
              <div class="quantity-control">
                <button 
                  class="qty-btn"
                  (click)="updateQuantity(cartItem.item.barcode, cartItem.quantity - 1)"
                  [disabled]="cartItem.quantity <= 1">
                  -
                </button>
                <span class="quantity">{{ cartItem.quantity }}</span>
                <button 
                  class="qty-btn"
                  (click)="updateQuantity(cartItem.item.barcode, cartItem.quantity + 1)"
                  [disabled]="cartItem.quantity >= cartItem.item.quantity">
                  +
                </button>
              </div>
              
              <div class="item-total">
                ${{ (cartItem.item.price * cartItem.quantity).toFixed(2) }}
              </div>
              
              <button class="remove-btn" (click)="removeFromCart(cartItem.item.barcode)">
                Remove
              </button>
            </div>
          </div>
        }
        
        <div class="cart-summary">
          <div class="summary-row">
            <span class="label">Subtotal:</span>
            <span class="value">${{ cartService.cartTotal().toFixed(2) }}</span>
          </div>
          <div class="summary-row total">
            <span class="label">Total:</span>
            <span class="value">${{ cartService.cartTotal().toFixed(2) }}</span>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<!-- Checkout Modal -->
@if (showCheckoutModal()) {
  <div class="modal-overlay" (click)="closeCheckoutModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      @if (!completedSale()) {
        <div class="modal-header">
          <h2>Checkout</h2>
          <button class="close-button" (click)="closeCheckoutModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <div class="checkout-summary">
            <h3>Order Summary</h3>
            
            @for (cartItem of cartService.cart(); track cartItem.item.barcode) {
              <div class="checkout-item">
                <span class="item-name">{{ cartItem.item.name }}</span>
                <span class="item-qty">x{{ cartItem.quantity }}</span>
                <span class="item-price">${{ (cartItem.item.price * cartItem.quantity).toFixed(2) }}</span>
              </div>
            }
            
            <div class="checkout-total">
              <span>Total Amount:</span>
              <span class="total-amount">${{ cartService.cartTotal().toFixed(2) }}</span>
            </div>
          </div>
        </div>
        
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeCheckoutModal()">Cancel</button>
            <button class="btn btn-primary" (click)="finalizeSale()">Complete Sale</button>
          </div>
      } @else {
        <div class="modal-header success">
          <h2>‚úì Sale Completed!</h2>
        </div>
        
        <div class="modal-body">
          <div class="receipt">
            <h3>Receipt</h3>
            <p class="receipt-id">Sale ID: {{ completedSale()?.id }}</p>
            <p class="receipt-date">{{ completedSale()?.timestamp | date:'medium' }}</p>
            
            <div class="receipt-items">
              @for (item of completedSale()?.items; track item.item.barcode) {
                <div class="receipt-item">
                  <span>{{ item.item.name }}</span>
                  <span>x{{ item.quantity }}</span>
                  <span>${{ (item.item.price * item.quantity).toFixed(2) }}</span>
                </div>
              }
            </div>
            
            <div class="receipt-total">
              <strong>Total:</strong>
              <strong>${{ (completedSale()?.total || 0).toFixed(2) }}</strong>
            </div>
          </div>
        </div>
        
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="printReceipt()">Print Receipt</button>
            <button class="btn btn-primary" (click)="startNewSale()">New Sale</button>
          </div>
      }
    </div>
  </div>
}

<!-- QR Payment Modal for Sellers -->
<app-qr-payment
  [visible]="showQRPayment()"
  [paymentAmount]="cartService.cartTotal()"
  [saleId]="pendingSaleId()"
  (paymentCompleted)="onPaymentReceived($event)"
  (cancelled)="onPaymentCancelled()">
</app-qr-payment>

<app-toast></app-toast>

